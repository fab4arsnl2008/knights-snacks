<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WYSA Knights Snack Schedule</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#F9FAFB]">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyDNVA6hBnk1F-TD_pheKUOLE6dwuiYfpZ4",
          authDomain: "knights-snacks.firebaseapp.com",
          projectId: "knights-snacks",
          storageBucket: "knights-snacks.firebasestorage.app",
          messagingSenderId: "680090441956",
          appId: "1:680090441956:web:17d34365668fb494a434f1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- ICONS (Inline to prevent crashes) ---
        const IconBase = ({ children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>
        );
        const Calendar = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Users = (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>;
        const Cookie = (props) => <IconBase {...props}><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"/><path d="M8.5 8.5v.01"/><path d="M16 15.5v.01"/><path d="M12 12v.01"/><path d="M11 17v.01"/><path d="M7 14v.01"/></IconBase>;

        // --- CONSTANTS ---
        const COLORS = {
            navy: '#15284B',    
            steel: '#3C6EAB',   
            white: '#FFFFFF',   
            silver: '#A8B3BD',  
            black: '#0D1115',   
        };

        const SCHEDULE_DATES = [
            { id: 'feb-28', display: 'Saturday, Feb 28 @1:10pm', short: 'Feb 28' },
            { id: 'mar-07', display: 'Saturday, Mar 7 @2:15pm', short: 'Mar 7' },
            { id: 'mar-28', display: 'Saturday, Mar 28 @11:15am', short: 'Mar 28' },
            { id: 'apr-04', display: 'Saturday, Apr 4 @11:15am', short: 'Apr 4' },
            { id: 'apr-11', display: 'Saturday, Apr 11 @1:00pm', short: 'Apr 11' },
            { id: 'apr-18', display: 'Saturday, Apr 18 @1:25pm', short: 'Apr 18' },
            { id: 'may-02', display: 'Saturday, May 2 @11:35am', short: 'May 2' },
            { id: 'may-09', display: 'Saturday, May 9 @1:55pm', short: 'May 9' },
        ];

        const appId = 'wylie-knights-2026';

        // --- MAIN COMPONENT ---
        const KnightsCalendar = () => {
            const [user, setUser] = React.useState(null);
            const [signups, setSignups] = React.useState({});
            const [loading, setLoading] = React.useState(true);
            const [selectedDate, setSelectedDate] = React.useState(null);
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [formData, setFormData] = React.useState({ parentName: '', childName: '' });
            const [viewMode, setViewMode] = React.useState('list'); // 'list', 'signup', 'manage', 'delete_confirm'

            // Auth
            React.useEffect(() => {
                signInAnonymously(auth);
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                });
                return () => unsubscribe();
            }, []);

            // Data Sync
            React.useEffect(() => {
                if (!user) return;
                const unsubscribe = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'snack_signups'), 
                    (snapshot) => {
                        const data = {};
                        snapshot.forEach(doc => {
                            data[doc.id] = doc.data();
                        });
                        setSignups(data);
                        setLoading(false);
                    },
                    (error) => {
                        console.error("Error fetching signups:", error);
                        setLoading(false);
                    }
                );
                return () => unsubscribe();
            }, [user]);

            // Handlers
            const handleDateClick = (dateObj) => {
                const existingSignup = signups[dateObj.id];
                setSelectedDate(dateObj);
                if (existingSignup) {
                    setFormData({ 
                        parentName: existingSignup.parentName, 
                        childName: existingSignup.childName || '' // Handle legacy records
                    });
                    setViewMode('manage');
                } else {
                    setFormData({ parentName: '', childName: '' });
                    setViewMode('signup');
                }
                setIsModalOpen(true);
            };

            const handleInputChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!selectedDate || !user) return;
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'snack_signups', selectedDate.id), {
                        parentName: formData.parentName,
                        childName: formData.childName,
                        dateId: selectedDate.id,
                        dateDisplay: selectedDate.display,
                        timestamp: serverTimestamp(),
                        userId: user.uid
                    });
                    closeModal();
                } catch (err) {
                    console.error("Error saving signup:", err);
                    alert("Error saving. Please try again.");
                }
            };

            const confirmDelete = async () => {
                if (!selectedDate || !user) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'snack_signups', selectedDate.id));
                    closeModal();
                } catch (err) {
                    console.error("Error removing signup:", err);
                }
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setSelectedDate(null);
                setFormData({ parentName: '', childName: '' });
            };

            const initiateCancel = () => setViewMode('delete_confirm');

            // --- SUB-COMPONENTS ---
            const Header = () => (
                <div className="w-full text-white shadow-lg relative overflow-hidden" style={{ backgroundColor: COLORS.navy }}>
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full transform translate-x-10 -translate-y-10"></div>
                    <div className="max-w-md mx-auto px-4 py-6 flex items-center justify-between relative z-10">
                        <div className="flex items-center space-x-4">
                            <div className="bg-white p-1 rounded-full shadow-md w-16 h-16 flex items-center justify-center shrink-0">
                                <img 
                                    src="https://raw.githubusercontent.com/fab4arsnl2008/vividmemories/refs/heads/main/images/Knights_Logo.png" 
                                    alt="Knights Logo" 
                                    className="w-14 h-14 object-contain"
                                />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold tracking-tight">WYSA Knights</h1>
                                <p className="text-sm opacity-80" style={{ color: COLORS.silver }}>Snack Schedule</p>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const ProgressBar = () => {
                const total = SCHEDULE_DATES.length;
                const filled = Object.keys(signups).length;
                const percentage = Math.round((filled / total) * 100);

                return (
                    <div className="bg-white p-4 mb-6 shadow-sm border-b border-gray-100">
                        <div className="flex justify-between text-sm mb-2 font-medium" style={{ color: COLORS.navy }}>
                            <span>Season Progress</span>
                            <span>{filled} of {total} Matches Covered</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2.5">
                            <div 
                                className="h-2.5 rounded-full transition-all duration-500" 
                                style={{ width: `${percentage}%`, backgroundColor: COLORS.steel }}
                            ></div>
                        </div>
                    </div>
                );
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: '#F3F4F6' }}>
                        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2" style={{ borderColor: COLORS.navy }}></div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-12 font-sans" style={{ backgroundColor: '#F9FAFB' }}>
                    <Header />
                    
                    <div className="max-w-md mx-auto">
                        <ProgressBar />

                        <div className="px-4 space-y-4">
                            <h2 className="text-lg font-bold flex items-center" style={{ color: COLORS.black }}>
                                <Calendar className="w-5 h-5 mr-2" style={{ color: COLORS.steel }} />
                                Upcoming Matches
                            </h2>

                            <div className="space-y-3">
                                {SCHEDULE_DATES.map((date) => {
                                    const isTaken = !!signups[date.id];
                                    const signupData = signups[date.id];

                                    return (
                                        <div 
                                            key={date.id}
                                            onClick={() => handleDateClick(date)}
                                            className={`
                                                relative overflow-hidden rounded-xl border shadow-sm transition-all duration-200 active:scale-95 cursor-pointer
                                                ${isTaken ? 'bg-white border-gray-200' : 'bg-white border-l-4'}
                                            `}
                                            style={{ borderLeftColor: isTaken ? 'transparent' : COLORS.steel }}
                                        >
                                            <div className="p-4 flex items-center justify-between">
                                                {/* Left Side: Date */}
                                                <div className="flex flex-col">
                                                    <span className="text-xs font-bold uppercase tracking-wider text-gray-400">Match Day</span>
                                                    <span className="text-lg font-bold" style={{ color: COLORS.navy }}>{date.display}</span>
                                                </div>

                                                {/* Right Side: Status */}
                                                <div className="flex items-center">
                                                    {isTaken ? (
                                                        <div className="flex items-center space-x-3 bg-gray-50 px-3 py-2 rounded-lg border border-gray-100">
                                                            <div className="text-right">
                                                                <div className="text-xs text-gray-500 font-medium">Snacks by</div>
                                                                <div className="text-sm font-bold truncate max-w-[100px]" style={{ color: COLORS.navy }}>
                                                                    {signupData.parentName}
                                                                </div>
                                                            </div>
                                                            <CheckCircle className="w-6 h-6 text-green-500" />
                                                        </div>
                                                    ) : (
                                                        <button 
                                                            className="px-4 py-2 rounded-lg text-sm font-bold text-white shadow-md flex items-center"
                                                            style={{ backgroundColor: COLORS.steel }}
                                                        >
                                                            Sign Up <ChevronRight className="w-4 h-4 ml-1" />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Decorative faint icon bg */}
                                            {isTaken && (
                                                <Cookie className="absolute -bottom-2 -left-2 w-16 h-16 text-gray-100 opacity-50 rotate-12" />
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* Modal Overlay */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4 sm:p-6">
                            <div 
                                className="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity"
                                onClick={closeModal}
                            ></div>
                            
                            <div 
                                className="relative bg-white rounded-t-2xl sm:rounded-2xl shadow-xl w-full max-w-md overflow-hidden transform transition-all"
                                style={{ maxHeight: '90vh' }}
                            >
                                {/* Modal Header */}
                                <div className="p-6 pb-4" style={{ backgroundColor: COLORS.navy }}>
                                    <div className="flex justify-between items-start text-white">
                                        <div>
                                            <h3 className="text-xl font-bold">
                                                {viewMode === 'signup' && 'Bring Snacks'}
                                                {viewMode === 'manage' && 'Managed Slot'}
                                                {viewMode === 'delete_confirm' && 'Confirm Cancellation'}
                                            </h3>
                                            <p className="text-sm opacity-80 mt-1 flex items-center">
                                                <Calendar className="w-3 h-3 mr-1" />
                                                {selectedDate?.display}
                                            </p>
                                        </div>
                                        <button onClick={closeModal} className="text-white/70 hover:text-white">
                                            <X className="w-6 h-6" />
                                        </button>
                                    </div>
                                </div>

                                {/* Modal Body */}
                                <div className="p-6">
                                    {viewMode === 'signup' && (
                                        <form onSubmit={handleSubmit} className="space-y-5">
                                            <div>
                                                <label className="block text-sm font-medium mb-1" style={{ color: COLORS.navy }}>Parent Name</label>
                                                <div className="relative">
                                                    <User className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
                                                    <input
                                                        required
                                                        type="text"
                                                        name="parentName"
                                                        value={formData.parentName}
                                                        onChange={handleInputChange}
                                                        placeholder="e.g. John Doe"
                                                        className="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                                                    />
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium mb-1" style={{ color: COLORS.navy }}>Player Name</label>
                                                <div className="relative">
                                                    <Users className="absolute left-3 top-3 w-5 h-5 text-gray-400" />
                                                    <input
                                                        required
                                                        type="text"
                                                        name="childName"
                                                        value={formData.childName}
                                                        onChange={handleInputChange}
                                                        placeholder="e.g. Leo"
                                                        className="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                                                    />
                                                </div>
                                            </div>

                                            <button
                                                type="submit"
                                                className="w-full py-4 rounded-xl font-bold text-white text-lg shadow-lg hover:brightness-110 transition-all active:scale-95"
                                                style={{ backgroundColor: COLORS.steel }}
                                            >
                                                Confirm Signup
                                            </button>
                                        </form>
                                    )}

                                    {viewMode === 'manage' && (
                                        <div className="space-y-6 text-center">
                                            <div className="mx-auto w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-4">
                                                <CheckCircle className="w-10 h-10 text-green-600" />
                                            </div>
                                            
                                            <div>
                                                <h4 className="text-gray-500 text-sm uppercase tracking-wide font-bold">Provider</h4>
                                                <p className="text-2xl font-bold" style={{ color: COLORS.navy }}>{formData.parentName}</p>
                                                <p className="text-gray-500 text-sm mt-1">Parent of {formData.childName}</p>
                                            </div>

                                            <div className="pt-6 border-t border-gray-100">
                                                <p className="text-sm text-gray-500 mb-4">Need to change plans? You can release this slot so another parent can sign up.</p>
                                                <button
                                                    onClick={initiateCancel}
                                                    className="w-full py-3 rounded-xl font-bold text-red-600 bg-red-50 hover:bg-red-100 border border-red-100 transition-all"
                                                >
                                                    Cancel Signup & Release Date
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    {viewMode === 'delete_confirm' && (
                                        <div className="space-y-6 text-center">
                                            <div className="mx-auto w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mb-4">
                                                <AlertTriangle className="w-10 h-10 text-red-600" />
                                            </div>
                                            
                                            <div>
                                                <h4 className="text-red-700 text-lg font-bold">Are you sure?</h4>
                                                <p className="text-gray-600 mt-2">
                                                    This will remove <span className="font-bold">{formData.parentName}'s</span> commitment to bring snacks on <span className="font-bold">{selectedDate?.display}</span>.
                                                </p>
                                                <p className="text-sm text-gray-500 mt-2">The slot will become available for other parents.</p>
                                            </div>

                                            <div className="pt-4 grid grid-cols-2 gap-4">
                                                <button
                                                    onClick={() => setViewMode('manage')}
                                                    className="w-full py-3 rounded-xl font-bold text-gray-600 bg-gray-100 hover:bg-gray-200 transition-all"
                                                >
                                                    Go Back
                                                </button>
                                                <button
                                                    onClick={confirmDelete}
                                                    className="w-full py-3 rounded-xl font-bold text-white bg-red-600 hover:bg-red-700 shadow-lg transition-all"
                                                >
                                                    Yes, Remove
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Footer with Logo */}
                    <div className="flex justify-center mt-12 mb-8 opacity-80 hover:opacity-100 transition-opacity">
                        <img 
                            src="https://raw.githubusercontent.com/fab4arsnl2008/vividmemories/refs/heads/main/images/Knights_Logo.png" 
                            alt="Knights Logo" 
                            className="w-16 h-16 object-contain hover:grayscale transition-all duration-500"
                        />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<KnightsCalendar />);
    </script>
</body>
</html>
